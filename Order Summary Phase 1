// ===== SALES SUMMARY CONFIGURATION =====
const SALES_CONFIG = {
  SPREADSHEET_ID: '1b5On_VvQF-6i634aXhSHwjMIY_m-f2SLhPnBMfM1cJo',
  ORDERS_SHEET: 'Orders',
  SUMMARY_SHEET: 'Sales Summary',
  
  // Display names for the summary report
  PRODUCT_NAMES: {
    'Aæ¬¾â€”â€”ä¸°ç››æ¬¾': 'A.ä¸°ç››æ¬¾ï¼ˆé•¿ï¼‰',
    'Bæ¬¾â€”â€”èšè´¢æ¬¾': 'B.èšè´¢æ¬¾',
    'Cæ¬¾â€”â€”å¯Œè±ªæ¬¾': 'C.å¯Œè±ªæ¬¾ï¼ˆçŸ­ï¼‰',
    'Dæ¬¾â€”â€”å¸¦è´¢æ¬¾': 'D.å¸¦è´¢æ¬¾',
    'Eæ¬¾â€”â€”å¸é‡‘æ¬¾': 'E.å¸é‡‘æ¬¾ï¼ˆå¡åŒ…ï¼‰'
  },
  
  // Alternate product names mapping (from order format to standard format)
  ALT_NAMES: {
    'Aæ¬¾ï¼ˆä¸°ç››æ¬¾ï¼‰': 'Aæ¬¾â€”â€”ä¸°ç››æ¬¾',
    'Bæ¬¾ï¼ˆèšè´¢æ¬¾ï¼‰': 'Bæ¬¾â€”â€”èšè´¢æ¬¾',
    'Cæ¬¾ï¼ˆå¯Œè±ªæ¬¾ï¼‰': 'Cæ¬¾â€”â€”å¯Œè±ªæ¬¾',
    'Dæ¬¾ï¼ˆå¸¦è´¢æ¬¾x1ï¼‰': 'Dæ¬¾â€”â€”å¸¦è´¢æ¬¾',
    'Eæ¬¾ï¼ˆå¸é‡‘æ¬¾x1ï¼‰': 'Eæ¬¾â€”â€”å¸é‡‘æ¬¾'
  },
  
  // Bundle definitions: each bundle expands to multiple individual products
  BUNDLES: {
    'Fæ¬¾ï¼ˆå¸¦è´¢æ¬¾x1+å¸é‡‘æ¬¾x1ï¼‰': {
      'Dæ¬¾â€”â€”å¸¦è´¢æ¬¾': 1,
      'Eæ¬¾â€”â€”å¸é‡‘æ¬¾': 1
    },
    'Gæ¬¾ï¼ˆå¸¦è´¢æ¬¾x2ï¼‰': {
      'Dæ¬¾â€”â€”å¸¦è´¢æ¬¾': 2
    },
    'Hæ¬¾ï¼ˆå¸é‡‘æ¬¾x2ï¼‰': {
      'Eæ¬¾â€”â€”å¸é‡‘æ¬¾': 2
    }
  }
};

// ===== NORMALIZE PRODUCT STRING =====
// Removes extra spaces around Chinese punctuation for consistent matching
function normalizeProductString(str) {
  if (!str) return '';
  return str.replace(/\s+ï¼ˆ/g, 'ï¼ˆ')
    .replace(/ï¼‰\s+/g, 'ï¼‰')
    .replace(/\s+â€”â€”/g, 'â€”â€”')
    .replace(/â€”â€”\s+/g, 'â€”â€”')
    .replace(/\s+/g, ' ')
    .trim();
}

// ===== SMART SPLIT =====
// Splits order string by '+' but respects parentheses
// Example: "Aæ¬¾ï¼ˆä¸°ç››æ¬¾ï¼‰ x3 + Fæ¬¾ï¼ˆå¸¦è´¢æ¬¾x1+å¸é‡‘æ¬¾x1ï¼‰ x1"
// Results in: ["Aæ¬¾ï¼ˆä¸°ç››æ¬¾ï¼‰ x3", "Fæ¬¾ï¼ˆå¸¦è´¢æ¬¾x1+å¸é‡‘æ¬¾x1ï¼‰ x1"]
function smartSplit(str) {
  const parts = [];
  let currentPart = '';
  let depth = 0;
  
  for (let i = 0; i < str.length; i++) {
    const char = str[i];
    
    if (char === 'ï¼ˆ' || char === '(') {
      depth++;
      currentPart += char;
    } else if (char === 'ï¼‰' || char === ')') {
      depth--;
      currentPart += char;
    } else if (char === '+' && depth === 0) {
      // Only split on '+' when not inside parentheses
      if (currentPart.trim()) {
        parts.push(currentPart.trim());
      }
      currentPart = '';
    } else {
      currentPart += char;
    }
  }
  
  if (currentPart.trim()) {
    parts.push(currentPart.trim());
  }
  
  return parts;
}

// ===== PARSE PRODUCTS FOR SUMMARY =====
// Main parsing function that converts order summaries to product quantities
// Handles:
// - Individual products: "Aæ¬¾ï¼ˆä¸°ç››æ¬¾ï¼‰ x3" â†’ A:3
// - Bundles: "Fæ¬¾ï¼ˆå¸¦è´¢æ¬¾x1+å¸é‡‘æ¬¾x1ï¼‰ x1" â†’ D:1, E:1
// - Bundle multiples: "Gæ¬¾ï¼ˆå¸¦è´¢æ¬¾x2ï¼‰ x2" â†’ D:4 (2 bundles Ã— 2 items each)
function parseProductsForSummary(orderSummary) {
  const stockCount = {
    'Aæ¬¾â€”â€”ä¸°ç››æ¬¾': 0, 
    'Bæ¬¾â€”â€”èšè´¢æ¬¾': 0, 
    'Cæ¬¾â€”â€”å¯Œè±ªæ¬¾': 0,
    'Dæ¬¾â€”â€”å¸¦è´¢æ¬¾': 0, 
    'Eæ¬¾â€”â€”å¸é‡‘æ¬¾': 0
  };
  
  const normalized = normalizeProductString(orderSummary);
  const parts = smartSplit(normalized);

  for (const part of parts) {
    let matched = false;
    
    // STEP 1: Check if part is a BUNDLE (F/G/Hæ¬¾)
    for (const bundleName in SALES_CONFIG.BUNDLES) {
      const normBundle = normalizeProductString(bundleName);
      
      // Check if part starts with bundle name
      if (part.indexOf(normBundle) === 0) {
        // Extract quantity multiplier AFTER the bundle name
        const afterBundle = part.substring(normBundle.length).trim();
        let qty = 1; // Default to 1 bundle
        
        // Look for "x2" or "Ã— 3" pattern after bundle name
        const qtyMatch = afterBundle.match(/^[xXÃ—]\s*([0-9]+)/);
        if (qtyMatch) {
          qty = parseInt(qtyMatch[1]);
        }
        
        // Add individual products from the bundle (multiplied by bundle quantity)
        for (const product in SALES_CONFIG.BUNDLES[bundleName]) {
          stockCount[product] += SALES_CONFIG.BUNDLES[bundleName][product] * qty;
        }
        matched = true;
        break;
      }
    }

    // STEP 2: If not a bundle, check ALTERNATE NAMES (more specific patterns)
    if (!matched) {
      for (const alt in SALES_CONFIG.ALT_NAMES) {
        const targetKey = SALES_CONFIG.ALT_NAMES[alt];
        const na = normalizeProductString(alt);
        
        if (part.indexOf(na) === 0) {
          const match = part.match(/[xXÃ—]\s*([0-9]+)/);
          const qty = match ? parseInt(match[1]) : 1;
          stockCount[targetKey] += qty;
          matched = true;
          break;
        }
      }
      
      // STEP 3: If still not matched, check MAIN PRODUCT NAMES
      if (!matched) {
        for (const k in stockCount) {
          const nk = normalizeProductString(k);
          if (part.indexOf(nk) === 0) {
            const match = part.match(/[xXÃ—]\s*([0-9]+)/);
            const qty = match ? parseInt(match[1]) : 1;
            stockCount[k] += qty;
            break;
          }
        }
      }
    }
  }
  
  return stockCount;
}

// ===== MAIN FUNCTION =====
function generateSalesSummary() {
  const ss = SpreadsheetApp.openById(SALES_CONFIG.SPREADSHEET_ID);
  const ordersSheet = ss.getSheetByName(SALES_CONFIG.ORDERS_SHEET);
  if (!ordersSheet) throw new Error('Orders sheet not found!');

  const lastRow = ordersSheet.getLastRow();
  if (lastRow < 10) {
    SpreadsheetApp.getUi().alert('No orders found.');
    return;
  }

  // Read order data (starting from row 10, columns A-P)
  const data = ordersSheet.getRange(10, 1, lastRow - 9, 16).getValues();
  const summarySheet = ss.getSheetByName(SALES_CONFIG.SUMMARY_SHEET) || ss.insertSheet(SALES_CONFIG.SUMMARY_SHEET);
  summarySheet.clear();

  // === Phase 1 Yellow Header ===
  const now = new Date();
  const dateStr = Utilities.formatDate(now, Session.getScriptTimeZone(), 'dd MMM yyyy');
  const timeStr = Utilities.formatDate(now, Session.getScriptTimeZone(), 'h:mm a');

  summarySheet.getRange('A1:G1').merge().setValue('Phase 1 (2nd day from 3pm)')
    .setBackground('#FFFF00').setFontWeight('bold').setHorizontalAlignment('center').setFontSize(14);
  summarySheet.getRange('A2:G2').merge().setValue(`${dateStr} Wallet Sales Update (${timeStr})`)
    .setBackground('#FFFF00').setFontWeight('bold').setHorizontalAlignment('center').setFontSize(14);

  // Column headers
  const headers = [
    'Platform',
    SALES_CONFIG.PRODUCT_NAMES['Aæ¬¾â€”â€”ä¸°ç››æ¬¾'],
    SALES_CONFIG.PRODUCT_NAMES['Bæ¬¾â€”â€”èšè´¢æ¬¾'],
    SALES_CONFIG.PRODUCT_NAMES['Cæ¬¾â€”â€”å¯Œè±ªæ¬¾'],
    SALES_CONFIG.PRODUCT_NAMES['Dæ¬¾â€”â€”å¸¦è´¢æ¬¾'],
    SALES_CONFIG.PRODUCT_NAMES['Eæ¬¾â€”â€”å¸é‡‘æ¬¾'],
    'Total Sales'
  ];
  summarySheet.getRange(3, 1, 1, 7).setValues([headers])
    .setBackground('#FFFF00').setFontWeight('bold').setHorizontalAlignment('center')
    .setBorder(true, true, true, true, true, true);

  // === Platform summary ===
  const platformSummary = {
    'GHL': { 
      'Aæ¬¾â€”â€”ä¸°ç››æ¬¾': 0, 'Bæ¬¾â€”â€”èšè´¢æ¬¾': 0, 'Cæ¬¾â€”â€”å¯Œè±ªæ¬¾': 0, 
      'Dæ¬¾â€”â€”å¸¦è´¢æ¬¾': 0, 'Eæ¬¾â€”â€”å¸é‡‘æ¬¾': 0,
      totalSales: 0 
    },
    'Shopify (VIP)': { 
      'Aæ¬¾â€”â€”ä¸°ç››æ¬¾': 0, 'Bæ¬¾â€”â€”èšè´¢æ¬¾': 0, 'Cæ¬¾â€”â€”å¯Œè±ªæ¬¾': 0, 
      'Dæ¬¾â€”â€”å¸¦è´¢æ¬¾': 0, 'Eæ¬¾â€”â€”å¸é‡‘æ¬¾': 0,
      totalSales: 0 
    }
  };

  const dailySummary = {};

  // Process each order
  for (const row of data) {
    const status = String(row[13] || '').trim(); // Column N (index 13)
    const orderSummary = String(row[11] || '').trim(); // Column L (index 11)
    const totalPrice = parseFloat(String(row[12] || '').replace(/[^\d.]/g, '')) || 0; // Column M
    const platform = String(row[9] || 'GHL').trim(); // Column J (index 9)
    const dateRaw = row[0]; // Column A (index 0)
    
    // Only process Pending or Created orders with valid data
    if (!dateRaw || !orderSummary || (status !== 'Pending' && status !== 'Created')) continue;
    
    const orderDate = Utilities.formatDate(new Date(dateRaw), Session.getScriptTimeZone(), 'yyyy-MM-dd');

    // Determine platform category
    const platformKey = platform.toLowerCase().includes('shopify') ? 'Shopify (VIP)' : 'GHL';
    
    // Parse products from order summary
    const stockCount = parseProductsForSummary(orderSummary);

    // Accumulate platform totals
    for (const k in stockCount) {
      platformSummary[platformKey][k] += stockCount[k];
    }
    platformSummary[platformKey].totalSales += totalPrice;

    // Daily accumulation
    if (!dailySummary[orderDate]) {
      dailySummary[orderDate] = { 
        'Aæ¬¾â€”â€”ä¸°ç››æ¬¾': 0, 'Bæ¬¾â€”â€”èšè´¢æ¬¾': 0, 'Cæ¬¾â€”â€”å¯Œè±ªæ¬¾': 0,
        'Dæ¬¾â€”â€”å¸¦è´¢æ¬¾': 0, 'Eæ¬¾â€”â€”å¸é‡‘æ¬¾': 0,
        totalSales: 0 
      };
    }
    for (const k in stockCount) {
      dailySummary[orderDate][k] += stockCount[k];
    }
    dailySummary[orderDate].totalSales += totalPrice;
  }

  // Calculate grand totals
  const totals = {
    'Aæ¬¾â€”â€”ä¸°ç››æ¬¾': platformSummary['GHL']['Aæ¬¾â€”â€”ä¸°ç››æ¬¾'] + platformSummary['Shopify (VIP)']['Aæ¬¾â€”â€”ä¸°ç››æ¬¾'],
    'Bæ¬¾â€”â€”èšè´¢æ¬¾': platformSummary['GHL']['Bæ¬¾â€”â€”èšè´¢æ¬¾'] + platformSummary['Shopify (VIP)']['Bæ¬¾â€”â€”èšè´¢æ¬¾'],
    'Cæ¬¾â€”â€”å¯Œè±ªæ¬¾': platformSummary['GHL']['Cæ¬¾â€”â€”å¯Œè±ªæ¬¾'] + platformSummary['Shopify (VIP)']['Cæ¬¾â€”â€”å¯Œè±ªæ¬¾'],
    'Dæ¬¾â€”â€”å¸¦è´¢æ¬¾': platformSummary['GHL']['Dæ¬¾â€”â€”å¸¦è´¢æ¬¾'] + platformSummary['Shopify (VIP)']['Dæ¬¾â€”â€”å¸¦è´¢æ¬¾'],
    'Eæ¬¾â€”â€”å¸é‡‘æ¬¾': platformSummary['GHL']['Eæ¬¾â€”â€”å¸é‡‘æ¬¾'] + platformSummary['Shopify (VIP)']['Eæ¬¾â€”â€”å¸é‡‘æ¬¾'],
    totalSales: platformSummary['GHL'].totalSales + platformSummary['Shopify (VIP)'].totalSales
  };

  // === Write summary table ===
  summarySheet.getRange(4, 1, 1, 7).setValues([[
    'GHL',
    platformSummary['GHL']['Aæ¬¾â€”â€”ä¸°ç››æ¬¾'],
    platformSummary['GHL']['Bæ¬¾â€”â€”èšè´¢æ¬¾'],
    platformSummary['GHL']['Cæ¬¾â€”â€”å¯Œè±ªæ¬¾'],
    platformSummary['GHL']['Dæ¬¾â€”â€”å¸¦è´¢æ¬¾'],
    platformSummary['GHL']['Eæ¬¾â€”â€”å¸é‡‘æ¬¾'],
    platformSummary['GHL'].totalSales
  ]]).setBorder(true, true, true, true, true, true);

  summarySheet.getRange(5, 1, 1, 7).setValues([[
    'Shopify (VIP)',
    platformSummary['Shopify (VIP)']['Aæ¬¾â€”â€”ä¸°ç››æ¬¾'],
    platformSummary['Shopify (VIP)']['Bæ¬¾â€”â€”èšè´¢æ¬¾'],
    platformSummary['Shopify (VIP)']['Cæ¬¾â€”â€”å¯Œè±ªæ¬¾'],
    platformSummary['Shopify (VIP)']['Dæ¬¾â€”â€”å¸¦è´¢æ¬¾'],
    platformSummary['Shopify (VIP)']['Eæ¬¾â€”â€”å¸é‡‘æ¬¾'],
    platformSummary['Shopify (VIP)'].totalSales
  ]]).setBorder(true, true, true, true, true, true);

  summarySheet.getRange(6, 1, 1, 7).setValues([[
    'Total:',
    totals['Aæ¬¾â€”â€”ä¸°ç››æ¬¾'],
    totals['Bæ¬¾â€”â€”èšè´¢æ¬¾'],
    totals['Cæ¬¾â€”â€”å¯Œè±ªæ¬¾'],
    totals['Dæ¬¾â€”â€”å¸¦è´¢æ¬¾'],
    totals['Eæ¬¾â€”â€”å¸é‡‘æ¬¾'],
    totals.totalSales
  ]]).setBackground('#FFD966').setFontWeight('bold').setBorder(true, true, true, true, true, true);

  // Format currency columns
  summarySheet.getRange('G4:G6').setNumberFormat('#,##0.00');
  summarySheet.getRange('A3:G6').setHorizontalAlignment('center');
  summarySheet.setColumnWidths(1, 7, 120);

  // === Append daily breakdown ===
  const startRow = 8;
  let r = startRow;
  const sortedDates = Object.keys(dailySummary).sort();

  for (const d of sortedDates) {
    const day = dailySummary[d];
    const rowVals = [
      `ğŸ“… ${d} (Daily Sales)`,
      day['Aæ¬¾â€”â€”ä¸°ç››æ¬¾'],
      day['Bæ¬¾â€”â€”èšè´¢æ¬¾'],
      day['Cæ¬¾â€”â€”å¯Œè±ªæ¬¾'],
      day['Dæ¬¾â€”â€”å¸¦è´¢æ¬¾'],
      day['Eæ¬¾â€”â€”å¸é‡‘æ¬¾'],
      day.totalSales
    ];
    summarySheet.getRange(r, 1, 1, 7).setValues([rowVals])
      .setFontWeight('bold')
      .setBackground('#D9E2F3')
      .setBorder(true, true, true, true, true, true)
      .setHorizontalAlignment('center');
    summarySheet.getRange(`G${r}`).setNumberFormat('#,##0.00');
    r++;
  }

  SpreadsheetApp.getUi().alert('âœ… Sales summary generated successfully!');
}

// ===== TEST FUNCTION (Optional - for debugging) =====
function testParsing() {
  const testOrders = [
    'Aæ¬¾ï¼ˆä¸°ç››æ¬¾ï¼‰ x3 + Fæ¬¾ï¼ˆå¸¦è´¢æ¬¾x1+å¸é‡‘æ¬¾x1ï¼‰ x1',
    'Aæ¬¾ï¼ˆä¸°ç››æ¬¾ï¼‰ x2 + Bæ¬¾ï¼ˆèšè´¢æ¬¾ï¼‰ x1 + Gæ¬¾ï¼ˆå¸¦è´¢æ¬¾x2ï¼‰ x2',
    'Cæ¬¾ï¼ˆå¯Œè±ªæ¬¾ï¼‰ x2 + Gæ¬¾ï¼ˆå¸¦è´¢æ¬¾x2ï¼‰ x1',
    'Aæ¬¾ï¼ˆä¸°ç››æ¬¾ï¼‰ x1 + Cæ¬¾ï¼ˆå¯Œè±ªæ¬¾ï¼‰ x1 + Hæ¬¾ï¼ˆå¸é‡‘æ¬¾x2ï¼‰ x1',
    'Gæ¬¾ï¼ˆå¸¦è´¢æ¬¾x2ï¼‰ x1',
    'Bæ¬¾ï¼ˆèšè´¢æ¬¾ï¼‰ x1 + Gæ¬¾ï¼ˆå¸¦è´¢æ¬¾x2ï¼‰ x1'
  ];
  
  Logger.log('=== PARSING TEST ===');
  testOrders.forEach(order => {
    const result = parseProductsForSummary(order);
    Logger.log(`Order: ${order}`);
    Logger.log(`Result: A:${result['Aæ¬¾â€”â€”ä¸°ç››æ¬¾']} B:${result['Bæ¬¾â€”â€”èšè´¢æ¬¾']} C:${result['Cæ¬¾â€”â€”å¯Œè±ªæ¬¾']} D:${result['Dæ¬¾â€”â€”å¸¦è´¢æ¬¾']} E:${result['Eæ¬¾â€”â€”å¸é‡‘æ¬¾']}`);
    Logger.log('---');
  });
}

const BDAY_SETTINGS = {
  GMAIL_ADDRESS: 'customercare@mandarin.club',
  FORM_BASE_URL: 'https://script.google.com/macros/s/AKfycbzMxrnjDSq2u7bnf51WlrTHu-fH93LbIYFYEGx5Kw5LWagMMxpq8SLScNOP1E8dp3WAzg/exec',
  SHEET_NAME: 'Orders',
  BATCH_LIMIT: 5,
  SKIP_SINGLE_WALLET: true,
  COLUMNS: {
    TIME_STAMP: 1,
    ORDER_ID: 2,
    NAME: 3,
    EMAIL: 4,
    PHONE: 5,
    ADDRESS: 6,
    CITY: 7,
    STATE: 8,
    POSTCODE: 9,
    MAIN_PRODUCT: 10,
    QUANTITY: 11,
    ORDER_SUMMARY: 12,
    TOTAL_PRICE: 13,
    STATUS: 14,
    ERROR_MESSAGE: 15,
    SHOPIFY_ORDER_ID: 16,
    GOLDEN_CARD_STATUS: 17,
    GOLDEN_CARD: 18,
    FORM_ACCESS_TOKEN: 19
  }
};

function generateAccessToken(rowId, orderId) {
  const timestamp = new Date().getTime();
  const randomStr = Utilities.getUuid().substring(0, 8);
  const token = Utilities.base64Encode(rowId + '|' + orderId + '|' + timestamp + '|' + randomStr);
  return token;
}

function smartSplit(str) {
  const parts = [];
  let currentPart = '';
  let depth = 0;
  
  for (let i = 0; i < str.length; i++) {
    const char = str[i];
    
    if (char === 'Ôºà' || char === '(') {
      depth++;
      currentPart += char;
    } else if (char === 'Ôºâ' || char === ')') {
      depth--;
      currentPart += char;
    } else if (char === '+' && depth === 0) {
      if (currentPart.trim()) {
        parts.push(currentPart.trim());
      }
      currentPart = '';
    } else {
      currentPart += char;
    }
  }
  
  if (currentPart.trim()) {
    parts.push(currentPart.trim());
  }
  
  return parts;
}

function smartSplitQty(orderSummary) {
  if (!orderSummary || orderSummary === '') {
    return 0;
  }
  
  let totalQty = 0;
  const parts = smartSplit(orderSummary);
  
  for (let i = 0; i < parts.length; i++) {
    const part = parts[i].trim();
    const matches = part.match(/[xX√ó]\s*(\d+)\s*$/);
    
    if (matches && matches[1]) {
      const qty = parseInt(matches[1]);
      totalQty += qty;
      Logger.log('   üì¶ Found: ' + part + ' -> Qty: ' + qty);
    }
  }
  
  Logger.log('üìä Total wallets detected: ' + totalQty);
  return totalQty;
}

function processNextBdayOrder() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sh = ss.getSheetByName(BDAY_SETTINGS.SHEET_NAME);
    
    if (!sh) {
      Logger.log('‚ùå Sheet not found: ' + BDAY_SETTINGS.SHEET_NAME);
      return;
    }
    
    const lastRow = sh.getLastRow();
    Logger.log('üîç Checking sheet: ' + BDAY_SETTINGS.SHEET_NAME + ', Last row: ' + lastRow);
    
    for (let i = 2; i <= lastRow; i++) {
      const goldenCardStatus = sh.getRange(i, BDAY_SETTINGS.COLUMNS.GOLDEN_CARD_STATUS).getValue();
      
      if (goldenCardStatus === '') {
        const name = sh.getRange(i, BDAY_SETTINGS.COLUMNS.NAME).getValue();
        const email = sh.getRange(i, BDAY_SETTINGS.COLUMNS.EMAIL).getValue();
        const orderSummary = sh.getRange(i, BDAY_SETTINGS.COLUMNS.ORDER_SUMMARY).getValue();
        const orderId = sh.getRange(i, BDAY_SETTINGS.COLUMNS.ORDER_ID).getValue();
        
        const qty = smartSplitQty(orderSummary);
        
        if (name && email && qty > 0) {
          Logger.log('üìß Processing next pending order - Row ' + i);
          Logger.log('   Order: ' + orderId + ' - ' + name + ' (Qty: ' + qty + ')');
          
          if (BDAY_SETTINGS.SKIP_SINGLE_WALLET && qty === 1) {
            sh.getRange(i, BDAY_SETTINGS.COLUMNS.GOLDEN_CARD_STATUS).setValue('Skipped');
            sh.getRange(i, BDAY_SETTINGS.COLUMNS.GOLDEN_CARD).setValue('N/A - Single Wallet');
            Logger.log('‚è≠Ô∏è Skipped single wallet order (qty=1)');
            return;
          }
          
          const token = generateAccessToken(i, orderId);
          const formUrl = generateFormUrl(name, qty, i, orderId, token);
          
          if (sendBdayEmail(name, email, qty, i, orderId, formUrl)) {
            sh.getRange(i, BDAY_SETTINGS.COLUMNS.GOLDEN_CARD_STATUS).setValue('Pending');
            sh.getRange(i, BDAY_SETTINGS.COLUMNS.FORM_ACCESS_TOKEN).setValue(formUrl);
            Logger.log('‚úÖ Email sent to ' + email);
          } else {
            sh.getRange(i, BDAY_SETTINGS.COLUMNS.ERROR_MESSAGE).setValue('Email Failed');
            Logger.log('‚ùå Failed to send email to: ' + email);
          }
          
          return;
        }
      }
    }
    
    Logger.log('‚úÖ All Done - No pending orders found');
  } catch (error) {
    Logger.log('‚ùå Error in processNextBdayOrder: ' + error);
  }
}

function generateFormUrl(name, qty, rowId, orderId, token) {
  return BDAY_SETTINGS.FORM_BASE_URL + 
    '?name=' + encodeURIComponent(name) + 
    '&qty=' + qty + 
    '&row=' + rowId + 
    '&order=' + encodeURIComponent(orderId) +
    '&token=' + encodeURIComponent(token);
}

function processAllBdayOrders() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sh = ss.getSheetByName(BDAY_SETTINGS.SHEET_NAME);
    
    if (!sh) {
      Logger.log('‚ùå Sheet not found: ' + BDAY_SETTINGS.SHEET_NAME);
      SpreadsheetApp.getUi().alert('Error', 'Sheet not found: ' + BDAY_SETTINGS.SHEET_NAME, SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }
    
    const lastRow = sh.getLastRow();
    Logger.log('üîç Checking sheet: ' + BDAY_SETTINGS.SHEET_NAME + ', Last row: ' + lastRow);
    
    if (lastRow < 2) {
      Logger.log('‚ÑπÔ∏è No orders to process');
      SpreadsheetApp.getUi().alert('Info', 'No orders to process', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }
    
    const batchLimit = BDAY_SETTINGS.BATCH_LIMIT;
    Logger.log('üìä Batch limit set to: ' + batchLimit + ' emails');
    
    let processed = 0;
    let errors = 0;
    let skipped = 0;
    let singleWalletSkipped = 0;
    
    for (let i = 2; i <= lastRow; i++) {
      if (processed >= batchLimit) {
        Logger.log('‚è∏Ô∏è Batch limit reached (' + batchLimit + ' emails sent)');
        break;
      }
      
      const goldenCardStatus = sh.getRange(i, BDAY_SETTINGS.COLUMNS.GOLDEN_CARD_STATUS).getValue();
      
      if (goldenCardStatus === '') {
        const name = sh.getRange(i, BDAY_SETTINGS.COLUMNS.NAME).getValue();
        const email = sh.getRange(i, BDAY_SETTINGS.COLUMNS.EMAIL).getValue();
        const orderSummary = sh.getRange(i, BDAY_SETTINGS.COLUMNS.ORDER_SUMMARY).getValue();
        const orderId = sh.getRange(i, BDAY_SETTINGS.COLUMNS.ORDER_ID).getValue();
        
        const qty = smartSplitQty(orderSummary);
        
        if (name && email && qty > 0) {
          if (BDAY_SETTINGS.SKIP_SINGLE_WALLET && qty === 1) {
            Logger.log('\n‚è≠Ô∏è Skipping row ' + i + ' (single wallet order)');
            Logger.log('   Order: ' + orderId + ' - ' + name + ' (Qty: ' + qty + ')');
            sh.getRange(i, BDAY_SETTINGS.COLUMNS.GOLDEN_CARD_STATUS).setValue('Skipped');
            sh.getRange(i, BDAY_SETTINGS.COLUMNS.GOLDEN_CARD).setValue('N/A - Single Wallet');
            singleWalletSkipped++;
            continue;
          }
          
          Logger.log('\nüìß Processing row ' + i + ' (' + (processed + 1) + ' of ' + batchLimit + ')');
          Logger.log('   Order: ' + orderId + ' - ' + name + ' (Qty: ' + qty + ')');
          
          try {
            const token = generateAccessToken(i, orderId);
            const formUrl = generateFormUrl(name, qty, i, orderId, token);
            
            if (sendBdayEmail(name, email, qty, i, orderId, formUrl)) {
              sh.getRange(i, BDAY_SETTINGS.COLUMNS.GOLDEN_CARD_STATUS).setValue('Pending');
              sh.getRange(i, BDAY_SETTINGS.COLUMNS.FORM_ACCESS_TOKEN).setValue(formUrl);
              Logger.log('‚úÖ Email sent to ' + email);
              processed++;
              Utilities.sleep(1000);
            } else {
              sh.getRange(i, BDAY_SETTINGS.COLUMNS.ERROR_MESSAGE).setValue('Email Failed');
              Logger.log('‚ùå Failed to send email to: ' + email);
              errors++;
            }
          } catch (error) {
            errors++;
            Logger.log('‚ùå Error on row ' + i + ': ' + error);
            sh.getRange(i, BDAY_SETTINGS.COLUMNS.ERROR_MESSAGE).setValue('Error: ' + error.toString());
          }
        }
      } else if (goldenCardStatus === 'Pending' || goldenCardStatus === 'Complete' || goldenCardStatus === 'Skipped') {
        skipped++;
      }
    }
    
    let message = 'üéâ Batch Processing Complete\n\n';
    message += '‚úÖ Emails Sent: ' + processed + '\n';
    if (singleWalletSkipped > 0) {
      message += '‚è≠Ô∏è Single Wallets Auto-Skipped: ' + singleWalletSkipped + '\n';
    }
    message += '‚ùå Errors: ' + errors + '\n';
    if (skipped > 0) {
      message += '‚è≠Ô∏è Already Processed: ' + skipped + '\n';
    }
    message += '\nüìä Batch Limit: ' + batchLimit + ' emails per run';
    
    SpreadsheetApp.getUi().alert('‚úÖ Process Complete', message, SpreadsheetApp.getUi().ButtonSet.OK);
    
  } catch (error) {
    Logger.log('‚ùå Error in processAllBdayOrders: ' + error);
    SpreadsheetApp.getUi().alert('Error', error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

function sendBdayEmail(name, email, qty, rowId, orderId, formUrl) {
  try {
    Logger.log('üìß Sending email with form URL');
    
    const subject = 'üéÅ ÂÆåÊàêÊÇ®ÁöÑ' + qty + '‰∏™Èí±ÂåÖËÆ¢Âçï - ËØ∑Â°´ÂÜôÁîüÊó•ËµÑÊñô';
    
    const htmlBody = '<!DOCTYPE html>' +
      '<html><head><meta charset="UTF-8"><style>' +
      'body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f5f5f5}' +
      '.container{max-width:600px;margin:0 auto;background:white}' +
      '.header{background:#667eea;color:white;padding:30px;text-align:center}' +
      '.header h1{margin:0;font-size:28px}' +
      '.header p{margin:5px 0 0 0;font-size:14px}' +
      '.customer-info{background:#e3f2fd;border-left:4px solid #1976d2;padding:15px;margin:20px}' +
      '.customer-info p{margin:8px 0;font-size:14px;color:#333}' +
      '.content{padding:30px 20px}' +
      '.section{margin:20px 0}' +
      '.section-title{font-size:16px;font-weight:bold;color:#333;margin-bottom:10px}' +
      '.requirement{margin:8px 0;font-size:14px;color:#555}' +
      '.requirement-item{margin-left:20px}' +
      '.button-container{text-align:center;margin:30px 0}' +
      '.button{display:inline-block;padding:14px 40px;background:#667eea;color:white;text-decoration:none;border-radius:6px;font-weight:bold;font-size:16px}' +
      '.button:hover{background:#5568d3}' +
      '.warning{background:#fff3cd;border-left:4px solid #ffc107;padding:12px;margin:20px;font-size:13px;color:#856404}' +
      '.footer{background:#f8f8f8;padding:20px;text-align:center;border-top:1px solid #eee;font-size:12px;color:#666}' +
      '.footer p{margin:5px 0}' +
      '</style></head><body>' +
      '<div class="container">' +
      '<div class="header">' +
      '<h1>Êª°ÈáëÂåÖ 2026</h1>' +
      '<p>Â•áÈó®ÈÅÅÁî≤ ¬∑ ÊãõË¥¢ÈòµÂÆöÂà∂</p>' +
      '</div>' +
      '<div class="customer-info">' +
      '<p><strong>üë§ ÂÆ¢Êà∑ÂßìÂêçÔºö</strong>' + name + '</p>' +
      '<p><strong>üéÅ ËÆ¢Ë¥≠Êï∞ÈáèÔºö</strong>' + qty + ' ‰∏™Èí±ÂåÖ</p>' +
      '</div>' +
      '<div class="content">' +
      '<div class="section">' +
      '<div class="section-title">‰Ω†Â•Ω' + name + 'Ôºå</div>' +
      '<p style="font-size:14px;color:#555;line-height:1.6">ÊÑüË∞¢ÊÇ®ÁöÑËÆ¢Ë¥≠ÔºÅ‰∏∫‰∫Ü‰∏∫ÊÇ®ËÆ°ÁÆó‰∏ìÂ±ûÁöÑ<strong>ÂëΩÂÆ´</strong>Âíå<strong>ÊãõË¥¢Èòµ</strong>ÔºåÊàë‰ª¨ÈúÄË¶ÅÊÇ®ÁöÑÁîüËæ∞ÂÖ´Â≠ó‰ø°ÊÅØ„ÄÇ</p>' +
      '</div>' +
      '<div class="section">' +
      '<div class="section-title">üìã ËØ∑Êèê‰æõ‰ª•‰∏ã‰ø°ÊÅØÔºö</div>' +
      '<div class="requirement-item">' +
      '<p class="requirement">‚úì Âá∫ÁîüÂπ¥ÊúàÊó•</p>' +
      '<p class="requirement">‚úì Âá∫ÁîüÊó∂Ëæ∞ÔºàÂèØÈÄâÔºâ</p>' +
      '</div>' +
      '</div>' +
      '<div class="button-container">' +
      '<a href="' + formUrl + '" class="button">üëâ È©¨‰∏äÂ°´ÂÜô</a>' +
      '</div>' +
      '<div class="warning">' +
      '<p><strong>‚è∞ ÈìæÊé•ÊúâÊïàÊúüÔºö24Â∞èÊó∂</strong></p>' +
      '<p>Ê≠§ÈìæÊé•ËØ∑Âú®24Â∞èÊó∂ÂÜÖÂÆåÊàêÂ°´ÂÜô„ÄÇÂÆåÊàêÂêéÂèØÈöèÊó∂ÈÄöËøáÊ≠§ÈìæÊé•Êü•ÁúãÁªìÊûú„ÄÇ</p>' +
      '</div>' +
      '<p style="font-size:13px;color:#666;margin-top:20px">Á≥ªÁªüÂ∞ÜËá™Âä®ÈÄöËøáÂ•áÈó®ÈÅÅÁî≤ÁÆóÊ≥ïËÆ°ÁÆóÊÇ®ÁöÑÂëΩÂÆ´ÔºåÂπ∂‰∏∫ÊÇ®ÂåπÈÖçÊúÄÈÄÇÂêàÁöÑÊãõË¥¢Èòµ„ÄÇ</p>' +
      '</div>' +
      '<div class="footer">' +
      '<p><strong>Ëã•Êúâ‰ªª‰ΩïÁñëÈóÆÔºåËØ∑ËÅîÁ≥ªÊàë‰ª¨Ôºö</strong></p>' +
      '<p>üìû +6013-928 4699</p>' +
      '<p>üìû +6013-530 8863</p>' +
      '<p style="margin-top:15px;color:#999">Ê≠§ÈÇÆ‰ª∂Áî±Êª°ÈáëÂåÖÂÆòÊñπÁ≥ªÁªüÂèëÈÄÅÔºåËØ∑ÂãøÁõ¥Êé•ÂõûÂ§ç„ÄÇ</p>' +
      '</div>' +
      '</div></body></html>';
    
    const plainText = 'Êª°ÈáëÂåÖ 2026 - ÁîüËæ∞ÂÖ´Â≠ó‰ø°ÊÅØÂ°´ÂÜô\n\n' +
      '‰∫≤Áà±ÁöÑ ' + name + 'Ôºå\n\n' +
      'ËÆ¢Ë¥≠Êï∞ÈáèÔºö' + qty + ' ‰∏™Èí±ÂåÖ\n\n' +
      'ÊÑüË∞¢ÊÇ®ÁöÑËÆ¢Ë¥≠ÔºÅ‰∏∫‰∫Ü‰∏∫ÊÇ®ËÆ°ÁÆó‰∏ìÂ±ûÁöÑÂëΩÂÆ´ÂíåÊãõË¥¢ÈòµÔºåÊàë‰ª¨ÈúÄË¶ÅÊÇ®ÁöÑÁîüËæ∞ÂÖ´Â≠ó‰ø°ÊÅØ„ÄÇ\n\n' +
      'ËØ∑Êèê‰æõ‰ª•‰∏ã‰ø°ÊÅØÔºö\n' +
      '‚úì Âá∫ÁîüÂπ¥ÊúàÊó•\n' +
      '‚úì Âá∫ÁîüÊó∂Ëæ∞ÔºàÂèØÈÄâÔºâ\n\n' +
      'ËØ∑ÁÇπÂáª‰ª•‰∏ãÈìæÊé•Â°´ÂÜôÔºà24Â∞èÊó∂ÂÜÖÊúâÊïàÔºâÔºö\n' + formUrl + '\n\n' +
      '‚è∞ ÈáçË¶ÅÊèêÁ§∫Ôºö\n' +
      'Ê≠§ÈìæÊé•ËØ∑Âú®24Â∞èÊó∂ÂÜÖÂÆåÊàêÂ°´ÂÜô„ÄÇÂÆåÊàêÂêéÂèØÈöèÊó∂ÈÄöËøáÊ≠§ÈìæÊé•Êü•ÁúãÁªìÊûú„ÄÇ\n\n' +
      'Ëã•Êúâ‰ªª‰ΩïÁñëÈóÆÔºåËØ∑ËÅîÁ≥ªÂÆ¢ÊúçÔºö\n' +
      'üìû +6013-928 4699\n' +
      'üìû +6013-530 8863\n\n' +
      'Ê≠§ÈÇÆ‰ª∂Áî±Êª°ÈáëÂåÖÂÆòÊñπÁ≥ªÁªüÂèëÈÄÅÔºåËØ∑ÂãøÁõ¥Êé•ÂõûÂ§ç„ÄÇ';
    
    MailApp.sendEmail({
      to: email,
      subject: subject,
      body: plainText,
      htmlBody: htmlBody,
      name: 'Mandarin Club - Êª°ÈáëÂåÖ',
      replyTo: BDAY_SETTINGS.GMAIL_ADDRESS,
      charset: 'UTF-8',
      noReply: false
    });
    
    return true;
  } catch (error) {
    Logger.log('‚ùå Error in sendBdayEmail: ' + error);
    return false;
  }
}

function authorizeBdayEmail() {
  MailApp.sendEmail({
    to: Session.getActiveUser().getEmail(),
    subject: '‚úÖ Email Authorization Successful - Mandarin Club',
    body: 'Your Google Apps Script now has permission to send emails!\n\nMandarin Club Birthday Form System',
    name: 'Mandarin Club - Êª°ÈáëÂåÖ'
  });
  Logger.log('‚úÖ Authorization complete!');
}

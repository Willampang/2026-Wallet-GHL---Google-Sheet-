const BDAY_SETTINGS = {
  GMAIL_ADDRESS: 'customercare@mandarin.club',
  FORM_BASE_URL: 'https://script.google.com/macros/s/AKfycbzHY85Zx1gaDHZyedN4Sh0G1ZyQ_BbnS4CC9Av2HyZhb1fKvFuKlWiL7DJv8YJZ8M-vdQ/exec',
  SHEET_NAME: 'Orders',
  BATCH_LIMIT: 5,
  SKIP_SINGLE_WALLET: true,
  COLUMNS: {
    TIME_STAMP: 1,
    ORDER_ID: 2,
    NAME: 3,
    EMAIL: 4,
    PHONE: 5,
    ADDRESS: 6,
    CITY: 7,
    STATE: 8,
    POSTCODE: 9,
    MAIN_PRODUCT: 10,
    QUANTITY: 11,
    ORDER_SUMMARY: 12,
    TOTAL_PRICE: 13,
    STATUS: 14,
    ERROR_MESSAGE: 15,
    SHOPIFY_ORDER_ID: 16,
    GOLDEN_CARD_STATUS: 17,
    GOLDEN_CARD: 18,
    FORM_ACCESS_TOKEN: 19
  }
};

function generateAccessToken(rowId, orderId) {
  const timestamp = new Date().getTime();
  const randomStr = Utilities.getUuid().substring(0, 8);
  const token = Utilities.base64Encode(rowId + '|' + orderId + '|' + timestamp + '|' + randomStr);
  return token;
}

function smartSplit(str) {
  const parts = [];
  let currentPart = '';
  let depth = 0;
  
  for (let i = 0; i < str.length; i++) {
    const char = str[i];
    
    if (char === 'Ôºà' || char === '(') {
      depth++;
      currentPart += char;
    } else if (char === 'Ôºâ' || char === ')') {
      depth--;
      currentPart += char;
    } else if (char === '+' && depth === 0) {
      if (currentPart.trim()) {
        parts.push(currentPart.trim());
      }
      currentPart = '';
    } else {
      currentPart += char;
    }
  }
  
  if (currentPart.trim()) {
    parts.push(currentPart.trim());
  }
  
  return parts;
}

function smartSplitQty(orderSummary) {
  if (!orderSummary || orderSummary === '') {
    return 0;
  }
  
  let totalQty = 0;
  const parts = smartSplit(orderSummary);
  
  for (let i = 0; i < parts.length; i++) {
    const part = parts[i].trim();
    const matches = part.match(/[xX√ó]\s*(\d+)\s*$/);
    
    if (matches && matches[1]) {
      const qty = parseInt(matches[1]);
      totalQty += qty;
      Logger.log('   üì¶ Found: ' + part + ' -> Qty: ' + qty);
    }
  }
  
  Logger.log('üìä Total wallets detected: ' + totalQty);
  return totalQty;
}

function processNextBdayOrder() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sh = ss.getSheetByName(BDAY_SETTINGS.SHEET_NAME);
    
    if (!sh) {
      Logger.log('‚ùå Sheet not found: ' + BDAY_SETTINGS.SHEET_NAME);
      return;
    }
    
    const lastRow = sh.getLastRow();
    Logger.log('üîç Checking sheet: ' + BDAY_SETTINGS.SHEET_NAME + ', Last row: ' + lastRow);
    
    for (let i = 2; i <= lastRow; i++) {
      const goldenCardStatus = sh.getRange(i, BDAY_SETTINGS.COLUMNS.GOLDEN_CARD_STATUS).getValue();
      
      if (goldenCardStatus === '') {
        const name = sh.getRange(i, BDAY_SETTINGS.COLUMNS.NAME).getValue();
        const email = sh.getRange(i, BDAY_SETTINGS.COLUMNS.EMAIL).getValue();
        const orderSummary = sh.getRange(i, BDAY_SETTINGS.COLUMNS.ORDER_SUMMARY).getValue();
        const orderId = sh.getRange(i, BDAY_SETTINGS.COLUMNS.ORDER_ID).getValue();
        
        const qty = smartSplitQty(orderSummary);
        
        if (name && email && qty > 0) {
          Logger.log('üìß Processing next pending order - Row ' + i);
          Logger.log('   Order: ' + orderId + ' - ' + name + ' (Qty: ' + qty + ')');
          
          if (BDAY_SETTINGS.SKIP_SINGLE_WALLET && qty === 1) {
            sh.getRange(i, BDAY_SETTINGS.COLUMNS.GOLDEN_CARD_STATUS).setValue('Skipped');
            sh.getRange(i, BDAY_SETTINGS.COLUMNS.GOLDEN_CARD).setValue('N/A - Single Wallet');
            Logger.log('‚è≠Ô∏è Skipped single wallet order (qty=1)');
            return;
          }
          
          const token = generateAccessToken(i, orderId);
          const formUrl = generateFormUrl(name, qty, i, orderId, token);
          
          if (sendBdayEmail(name, email, qty, i, orderId, formUrl)) {
            sh.getRange(i, BDAY_SETTINGS.COLUMNS.GOLDEN_CARD_STATUS).setValue('Pending');
            sh.getRange(i, BDAY_SETTINGS.COLUMNS.FORM_ACCESS_TOKEN).setValue(formUrl);
            Logger.log('‚úÖ Email sent to ' + email);
          } else {
            sh.getRange(i, BDAY_SETTINGS.COLUMNS.ERROR_MESSAGE).setValue('Email Failed');
            Logger.log('‚ùå Failed to send email to: ' + email);
          }
          
          return;
        }
      }
    }
    
    Logger.log('‚úÖ All Done - No pending orders found');
  } catch (error) {
    Logger.log('‚ùå Error in processNextBdayOrder: ' + error);
  }
}

function generateFormUrl(name, qty, rowId, orderId, token) {
  return BDAY_SETTINGS.FORM_BASE_URL + 
    '?name=' + encodeURIComponent(name) + 
    '&qty=' + qty + 
    '&row=' + rowId + 
    '&order=' + encodeURIComponent(orderId) +
    '&token=' + encodeURIComponent(token);
}

function processAllBdayOrders() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sh = ss.getSheetByName(BDAY_SETTINGS.SHEET_NAME);
    
    if (!sh) {
      Logger.log('‚ùå Sheet not found: ' + BDAY_SETTINGS.SHEET_NAME);
      SpreadsheetApp.getUi().alert('Error', 'Sheet not found: ' + BDAY_SETTINGS.SHEET_NAME, SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }
    
    const lastRow = sh.getLastRow();
    Logger.log('üîç Checking sheet: ' + BDAY_SETTINGS.SHEET_NAME + ', Last row: ' + lastRow);
    
    if (lastRow < 2) {
      Logger.log('‚ÑπÔ∏è No orders to process');
      SpreadsheetApp.getUi().alert('Info', 'No orders to process', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }
    
    const batchLimit = BDAY_SETTINGS.BATCH_LIMIT;
    Logger.log('üìä Batch limit set to: ' + batchLimit + ' emails');
    
    let processed = 0;
    let errors = 0;
    let skipped = 0;
    let singleWalletSkipped = 0;
    
    for (let i = 2; i <= lastRow; i++) {
      if (processed >= batchLimit) {
        Logger.log('‚è∏Ô∏è Batch limit reached (' + batchLimit + ' emails sent)');
        break;
      }
      
      const goldenCardStatus = sh.getRange(i, BDAY_SETTINGS.COLUMNS.GOLDEN_CARD_STATUS).getValue();
      
      if (goldenCardStatus === '') {
        const name = sh.getRange(i, BDAY_SETTINGS.COLUMNS.NAME).getValue();
        const email = sh.getRange(i, BDAY_SETTINGS.COLUMNS.EMAIL).getValue();
        const orderSummary = sh.getRange(i, BDAY_SETTINGS.COLUMNS.ORDER_SUMMARY).getValue();
        const orderId = sh.getRange(i, BDAY_SETTINGS.COLUMNS.ORDER_ID).getValue();
        
        const qty = smartSplitQty(orderSummary);
        
        if (name && email && qty > 0) {
          if (BDAY_SETTINGS.SKIP_SINGLE_WALLET && qty === 1) {
            Logger.log('\n‚è≠Ô∏è Skipping row ' + i + ' (single wallet order)');
            Logger.log('   Order: ' + orderId + ' - ' + name + ' (Qty: ' + qty + ')');
            sh.getRange(i, BDAY_SETTINGS.COLUMNS.GOLDEN_CARD_STATUS).setValue('Skipped');
            sh.getRange(i, BDAY_SETTINGS.COLUMNS.GOLDEN_CARD).setValue('N/A - Single Wallet');
            singleWalletSkipped++;
            continue;
          }
          
          Logger.log('\nüìß Processing row ' + i + ' (' + (processed + 1) + ' of ' + batchLimit + ')');
          Logger.log('   Order: ' + orderId + ' - ' + name + ' (Qty: ' + qty + ')');
          
          try {
            const token = generateAccessToken(i, orderId);
            const formUrl = generateFormUrl(name, qty, i, orderId, token);
            
            if (sendBdayEmail(name, email, qty, i, orderId, formUrl)) {
              sh.getRange(i, BDAY_SETTINGS.COLUMNS.GOLDEN_CARD_STATUS).setValue('Pending');
              sh.getRange(i, BDAY_SETTINGS.COLUMNS.FORM_ACCESS_TOKEN).setValue(formUrl);
              Logger.log('‚úÖ Email sent to ' + email);
              processed++;
              Utilities.sleep(1000);
            } else {
              sh.getRange(i, BDAY_SETTINGS.COLUMNS.ERROR_MESSAGE).setValue('Email Failed');
              Logger.log('‚ùå Failed to send email to: ' + email);
              errors++;
            }
          } catch (error) {
            errors++;
            Logger.log('‚ùå Error on row ' + i + ': ' + error);
            sh.getRange(i, BDAY_SETTINGS.COLUMNS.ERROR_MESSAGE).setValue('Error: ' + error.toString());
          }
        }
      } else if (goldenCardStatus === 'Pending' || goldenCardStatus === 'Complete' || goldenCardStatus === 'Skipped') {
        skipped++;
      }
    }
    
    let message = 'üéâ Batch Processing Complete\n\n';
    message += '‚úÖ Emails Sent: ' + processed + '\n';
    if (singleWalletSkipped > 0) {
      message += '‚è≠Ô∏è Single Wallets Auto-Skipped: ' + singleWalletSkipped + '\n';
    }
    message += '‚ùå Errors: ' + errors + '\n';
    if (skipped > 0) {
      message += '‚è≠Ô∏è Already Processed: ' + skipped + '\n';
    }
    message += '\nüìä Batch Limit: ' + batchLimit + ' emails per run';
    
    SpreadsheetApp.getUi().alert('‚úÖ Process Complete', message, SpreadsheetApp.getUi().ButtonSet.OK);
    
  } catch (error) {
    Logger.log('‚ùå Error in processAllBdayOrders: ' + error);
    SpreadsheetApp.getUi().alert('Error', error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

function sendBdayEmail(name, email, qty, rowId, orderId, formUrl) {
  try {
    Logger.log('üìß Sending email with form URL');
    
    const subject = 'ÂÆåÊàêÊÇ®ÁöÑÊª°ÈáëÂåÖËÆ¢Âçï - ËØ∑Â°´ÂÜôÁîüÊó•ËµÑÊñô (ËÆ¢Âçï #' + orderId + ')';
    
    // IMPROVED EMAIL HTML - More legitimate looking, less spammy
    const htmlBody = '<!DOCTYPE html>' +
      '<html lang="zh-CN"><head><meta charset="UTF-8">' +
      '<meta name="viewport" content="width=device-width, initial-scale=1.0">' +
      '<title>Êª°ÈáëÂåÖËÆ¢ÂçïÁ°ÆËÆ§</title></head><body style="margin:0;padding:0;font-family:Arial,sans-serif;background-color:#f5f5f5">' +
      '<table width="100%" cellpadding="0" cellspacing="0" style="background-color:#f5f5f5;padding:20px 0">' +
      '<tr><td align="center">' +
      '<table width="600" cellpadding="0" cellspacing="0" style="background-color:#ffffff;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1)">' +
      
      // Header
      '<tr><td style="background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%);padding:30px;text-align:center">' +
      '<h1 style="margin:0;color:#ffffff;font-size:28px;text-shadow:1px 1px 2px rgba(0,0,0,0.2)">Êª°ÈáëÂåÖ 2026</h1>' +
      '<p style="margin:8px 0 0 0;color:#ffffff;font-size:14px">Â•áÈó®ÈÅÅÁî≤ ¬∑ ÊãõË¥¢ÈòµÂÆöÂà∂</p>' +
      '</td></tr>' +
      
      // Customer Info
      '<tr><td style="padding:30px">' +
      '<table width="100%" cellpadding="0" cellspacing="0" style="background:#f9f9f9;border-left:4px solid #FFD700;padding:15px;border-radius:4px">' +
      '<tr><td><p style="margin:8px 0;font-size:14px;color:#333"><strong>üë§ Â∞äÊï¨ÁöÑÂÆ¢Êà∑Ôºö</strong>' + name + '</p>' +
      '<p style="margin:8px 0;font-size:14px;color:#333"><strong>üì¶ ËÆ¢ÂçïÁºñÂè∑Ôºö</strong>' + orderId + '</p>' +
      '<p style="margin:8px 0;font-size:14px;color:#333"><strong>üéÅ ËÆ¢Ë¥≠Êï∞ÈáèÔºö</strong>' + qty + ' ‰∏™Èí±ÂåÖ</p></td></tr>' +
      '</table>' +
      '</td></tr>' +
      
      // Main Content
      '<tr><td style="padding:0 30px 20px 30px">' +
      '<h2 style="color:#333;font-size:18px;margin:0 0 15px 0">ÊÑüË∞¢ÊÇ®ÁöÑËÆ¢Ë¥≠ÔºÅ</h2>' +
      '<p style="font-size:14px;color:#555;line-height:1.6;margin:0 0 15px 0">‰∏∫‰∫Ü‰∏∫ÊÇ®ËÆ°ÁÆó‰∏ìÂ±ûÁöÑ<strong>ÂëΩÂÆ´</strong>Âíå<strong>ÊãõË¥¢Èòµ</strong>ÔºåÊàë‰ª¨ÈúÄË¶ÅÊÇ®Êèê‰æõ‰ª•‰∏ã‰ø°ÊÅØÔºö</p>' +
      '<ul style="font-size:14px;color:#555;line-height:1.8;margin:0 0 20px 20px">' +
      '<li>Âá∫ÁîüÂπ¥ÊúàÊó•ÔºàÂøÖÂ°´Ôºâ</li>' +
      '<li>Âá∫ÁîüÊó∂Ëæ∞ÔºàÈÄâÂ°´Ôºå‰ΩÜÂèØ‰ª•ÊèêÈ´òÂáÜÁ°ÆÂ∫¶Ôºâ</li>' +
      '</ul>' +
      '</td></tr>' +
      
      // CTA Button
      '<tr><td style="padding:0 30px 30px 30px;text-align:center">' +
      '<a href="' + formUrl + '" style="display:inline-block;padding:14px 40px;background:#E63946;color:#ffffff;text-decoration:none;border-radius:6px;font-weight:bold;font-size:16px">È©¨‰∏äÂ°´ÂÜô</a>' +
      '</td></tr>' +
      
      // Important Notice
      '<tr><td style="padding:0 30px 20px 30px">' +
      '<table width="100%" cellpadding="0" cellspacing="0" style="background:#fff9e6;border-left:4px solid #FFD700;padding:15px;border-radius:4px">' +
      '<tr><td><p style="margin:0 0 8px 0;font-size:14px;color:#8B4513"><strong>‚è∞ ÈáçË¶ÅÊèêÁ§∫Ôºö</strong></p>' +
      '<p style="margin:0;font-size:13px;color:#8B4513;line-height:1.6">Ê≠§ÈìæÊé•ÊúâÊïàÊúü‰∏∫24Â∞èÊó∂ÔºåËØ∑Â∞ΩÂø´Â°´ÂÜô„ÄÇÂÆåÊàêÂêéÂèØÈöèÊó∂ÈÄöËøáÊ≠§ÈìæÊé•Êü•ÁúãÊÇ®ÁöÑÂëΩÂÆ´ÁªìÊûú„ÄÇ</p></td></tr>' +
      '</table>' +
      '</td></tr>' +
      
      // Footer
      '<tr><td style="background:#f9f9f9;padding:20px 30px;border-top:1px solid #e0e0e0;text-align:center">' +
      '<p style="margin:0 0 10px 0;font-size:13px;color:#666"><strong>ÂÆ¢ÊúçËÅîÁ≥ªÊñπÂºè</strong></p>' +
      '<p style="margin:5px 0;font-size:13px;color:#666">üìû +6013-928 4699 | +6013-530 8863</p>' +
      '<p style="margin:5px 0;font-size:13px;color:#666">üìß customercare@mandarin.club</p>' +
      '<p style="margin:15px 0 0 0;font-size:12px;color:#999">Ê≠§ÈÇÆ‰ª∂Áî± Mandarin Club ÂÆòÊñπÁ≥ªÁªüËá™Âä®ÂèëÈÄÅ</p>' +
      '</td></tr>' +
      
      '</table>' +
      '</td></tr></table>' +
      '</body></html>';
    
    const plainText = 'Êª°ÈáëÂåÖ 2026 - ËÆ¢ÂçïÁ°ÆËÆ§\n\n' +
      'Â∞äÊï¨ÁöÑ ' + name + ' ÊÇ®Â•ΩÔºå\n\n' +
      'ËÆ¢ÂçïÁºñÂè∑Ôºö' + orderId + '\n' +
      'ËÆ¢Ë¥≠Êï∞ÈáèÔºö' + qty + ' ‰∏™Èí±ÂåÖ\n\n' +
      'ÊÑüË∞¢ÊÇ®ÁöÑËÆ¢Ë¥≠ÔºÅ‰∏∫‰∫Ü‰∏∫ÊÇ®ËÆ°ÁÆó‰∏ìÂ±ûÁöÑÂëΩÂÆ´ÂíåÊãõË¥¢ÈòµÔºåÊàë‰ª¨ÈúÄË¶ÅÊÇ®ÁöÑÁîüËæ∞ÂÖ´Â≠ó‰ø°ÊÅØ„ÄÇ\n\n' +
      'ËØ∑Êèê‰æõ‰ª•‰∏ã‰ø°ÊÅØÔºö\n' +
      '‚úì Âá∫ÁîüÂπ¥ÊúàÊó•ÔºàÂøÖÂ°´Ôºâ\n' +
      '‚úì Âá∫ÁîüÊó∂Ëæ∞ÔºàÈÄâÂ°´Ôºâ\n\n' +
      'ËØ∑ÁÇπÂáª‰ª•‰∏ãÈìæÊé•Â°´ÂÜôÔºö\n' + formUrl + '\n\n' +
      '‚è∞ ÈáçË¶ÅÊèêÁ§∫Ôºö\n' +
      'Ê≠§ÈìæÊé•ÊúâÊïàÊúü‰∏∫24Â∞èÊó∂ÔºåËØ∑Â∞ΩÂø´ÂÆåÊàêÂ°´ÂÜô„ÄÇ\n\n' +
      'ÂÆ¢ÊúçËÅîÁ≥ªÊñπÂºèÔºö\n' +
      'üìû +6013-928 4699 / +6013-530 8863\n' +
      'üìß customercare@mandarin.club\n\n' +
      'Ê≠§ÈÇÆ‰ª∂Áî± Mandarin Club ÂÆòÊñπÁ≥ªÁªüËá™Âä®ÂèëÈÄÅÔºåËØ∑ÂãøÁõ¥Êé•ÂõûÂ§ç„ÄÇ\n' +
      '---\n' +
      'Mandarin Club\n' +
      'https://mandarin.club';
    
    // CRITICAL: Use the actual Gmail account that's authorized
    const authorizedEmail = Session.getActiveUser().getEmail();
    
    MailApp.sendEmail({
      to: email,
      subject: subject,
      body: plainText,
      htmlBody: htmlBody,
      name: 'Mandarin Club',
      replyTo: authorizedEmail, // Use authorized email instead
      charset: 'UTF-8',
      noReply: false
    });
    
    return true;
  } catch (error) {
    Logger.log('‚ùå Error in sendBdayEmail: ' + error);
    return false;
  }
}

function authorizeBdayEmail() {
  MailApp.sendEmail({
    to: Session.getActiveUser().getEmail(),
    subject: '‚úÖ Email Authorization Successful - Mandarin Club',
    body: 'Your Google Apps Script now has permission to send emails!\n\nMandarin Club Birthday Form System',
    name: 'Mandarin Club'
  });
  Logger.log('‚úÖ Authorization complete! Authorized email: ' + Session.getActiveUser().getEmail());
}
